<!-- ====== STYLE RINGKAS ====== -->
<style>
  .loops-group { display:block; margin-bottom:20px; }
  .loops-group label { font-weight:bold; }
  .loops-group input, .loops-group select, .loops-group textarea {
    display:block; width:100%; border:1px solid #ccc; border-radius:3px;
  }
  .loops-group input { height:36px; padding:6px 10px; }
  .loops-group select { height:45px; color:#7A7A7A; padding:5px 15px; background:#fff; }
  .loops-group input.loops-submit { background:#81bd4b; color:#fff; cursor:pointer; }
  .loops-footer { font-size:11px; color:#999; font-style:italic; }
  .red { color:#B30000; }
  .hint { font-size:12px; color:#666; margin-top:6px; }
  .error { color:#B30000; font-size:13px; margin-top:6px; display:none; }
  .success { color:#2b8a3e; font-size:13px; margin-top:6px; display:none; }
  .is-disabled { opacity:0.65; pointer-events:none; }
</style>

<!-- ====== FORM LOOPS ====== -->
<form id="loops-form-order" class="loops-forms"
      action="https://app.loops.id/save-order/test-lp-wa"
      method="POST" novalidate>

  <div class="loops-group">
    <label for="name">Nama lengkap <span class="red">*</span></label>
    <input type="text" id="name" name="name" placeholder="Tulis nama Anda" required />
  </div>

  <div class="loops-group">
    <label for="phone">No HP (WhatsApp) <span class="red">*</span></label>
    <input type="tel" id="phone" name="phone" inputmode="tel" autocomplete="tel"
           placeholder="081234567890 / +62812xxxx" required />
    <div id="phone-hint" class="hint">Format: 08xxxx / +62xxxx / 62xxxx</div>
    <div id="phone-error" class="error"></div>
    <div id="phone-success" class="success"></div>
  </div>

  <div class="loops-group">
    <input id="loops-form-submit" type="submit" value="Beli Sekarang" class="loops-submit" />
  </div>

  <!-- Hidden yang dikirim ke Loops -->
  <input type="hidden" id="current" name="current" value="" />
  <input type="hidden" id="redirect" name="redirect" value="" />
  <input type="hidden" id="_loops_nonce" name="_loops_nonce" value="" />
  <input type="hidden" id="phone_normalized" name="phone_normalized" value="" />

  <p class="loops-footer">Powered by <a href="https://loops.id/?utm_source=form-embed&utm_content=289729">Loops.id</a>.</p>
</form>

<!-- ====== SCRIPT VALIDASI ====== -->
<script>
  // === KONFIGURASI ===
  const WORKER_VALIDATE_URL = "https://vlidaiwwa.annasmashuri97.workers.dev/validate"; // <-- ganti ini
  const WA_START_CHAT = "https://wa.me/6289674494567?text=Start"; // opsional (auto buka WA)

  // === HELPER ===
  function normalizeIDNPhone(input) {
    const s = String(input || "").replace(/[^\d+]/g, "");
    if (!s) return "";
    if (s.startsWith("+62")) return s.slice(1);
    if (s.startsWith("62")) return s;
    if (s.startsWith("0")) return "62" + s.slice(1);
    if (s.startsWith("8")) return "62" + s;
    return "";
  }
  function basicPhoneCheck(norm) {
    return /^62\d{8,13}$/.test(norm);
  }

  const form = document.getElementById("loops-form-order");
  const btn = document.getElementById("loops-form-submit");
  const inpPhone = document.getElementById("phone");
  const err = document.getElementById("phone-error");
  const ok = document.getElementById("phone-success");
  const hiddenNorm = document.getElementById("phone_normalized");
  const hiddenRedirect = document.getElementById("redirect");

  function setBusy(b) {
    if (b) { btn.classList.add("is-disabled"); btn.value = "Mengecek WhatsApp..."; }
    else  { btn.classList.remove("is-disabled"); btn.value = "Beli Sekarang"; }
  }
  function showErr(msg) { err.textContent = msg; err.style.display = "block"; ok.style.display = "none"; }
  function showOk(msg) { ok.textContent = msg; ok.style.display = "block"; err.style.display = "none"; }

  form.addEventListener("submit", async (e) => {
    e.preventDefault(); // tahan submit sampai valid

    setBusy(true);
    try {
      const norm = normalizeIDNPhone(inpPhone.value);
      if (!norm || !basicPhoneCheck(norm)) {
        showErr("Nomor tidak valid. Gunakan format 08xxxx / +62xxxx / 62xxxx.");
        setBusy(false);
        inpPhone.focus();
        return;
      }

      const url = `${WORKER_VALIDATE_URL}?phone=${encodeURIComponent(norm)}`;
      const res = await fetch(url, { method: "GET", cache: "no-store" });
      const data = await res.json();

      if (!data?.ok) {
        showErr("Validasi gagal: " + (data?.error || "Server error"));
        setBusy(false);
        return;
      }

      if (!data.exists) {
        showErr("Nomor ini belum terdaftar di WhatsApp. Mohon cek kembali.");
        setBusy(false);
        return;
      }

      // Lulus validasi
      hiddenNorm.value = norm;

      // (Opsional) minta Loops redirect ke WA setelah submit sukses
      hiddenRedirect.value = WA_START_CHAT;

      showOk("Nomor terverifikasi di WhatsApp. Mengirim pesanan...");
      setTimeout(() => {
        form.submit(); // kirim ke Loops
      }, 120);
    } catch (ex) {
      console.error(ex);
      showErr("Terjadi kesalahan koneksi. Coba lagi.");
      setBusy(false);
    }
  });

  inpPhone.addEventListener("input", () => {
    err.style.display = "none";
    ok.style.display = "none";
  });

  // Simpan fbclid ke field hidden "current" agar ikut terkirim
  (function keepFbclid() {
    try {
      const u = new URL(window.location.href);
      const fbclid = u.searchParams.get("fbclid");
      if (!fbclid) return;
      const current = document.getElementById("current");
      if (current) current.value = fbclid;
    } catch (_) {}
  })();
</script>
