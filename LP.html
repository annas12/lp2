<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Pemesanan</title>
<style>
  :root{
    --green:#22a06b; --yellow:#ffd44d; --ink:#173B2C; --error:#c02929;
  }
  body{margin:0; font:16px/1.4 Inter,system-ui,Arial; background:#f9faf7; color:var(--ink); display:flex; justify-content:center; padding:20px}
  .form-box{max-width:420px; width:100%; background:#fff; padding:24px; border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.08)}
  h2{text-align:center; margin:0 0 20px; font-weight:800; font-size:22px; color:var(--green)}
  .group{margin-bottom:16px}
  label{display:block; font-weight:600; margin-bottom:6px}
  .input{
    width:100%; padding:12px; border:1.5px solid #e0e6e2; border-radius:10px; font-size:16px;
    outline:none; transition:.2s border;
  }
  .input:focus{border-color:var(--green)}
  .msg{font-size:13px; margin-top:6px; display:none}
  .msg.err{color:var(--error)}
  .msg.ok{color:var(--green)}
  .btn{
    width:100%; padding:14px; border:none; border-radius:12px;
    background:linear-gradient(90deg,var(--green),var(--yellow)); color:#fff;
    font-weight:700; font-size:17px; cursor:pointer; transition:.2s transform;
  }
  .btn:active{transform:scale(.98)}
</style>
</head>
<body>

<div class="form-box">
  <h2>Form Pemesanan</h2>
  <form id="orderForm" action="https://app.loops.id/save-order/test-lp-wa" method="POST" novalidate>
    <div class="group">
      <label for="name">Nama lengkap</label>
      <input class="input" id="name" name="name" required>
    </div>
    <div class="group">
      <label for="phone">No. WhatsApp</label>
      <input class="input" id="phone" name="phone" placeholder="0812xxxx" required>
      <div id="msg" class="msg err"></div>
      <div id="msgOk" class="msg ok"></div>
    </div>
    <button id="submitBtn" class="btn" type="submit">Ambil Promo</button>

    <!-- hidden untuk Loops -->
    <input type="hidden" id="phone_normalized" name="phone_normalized" value="">
    <input type="hidden" name="redirect" value="">
  </form>
</div>

<script>
  const WORKER_VALIDATE_URL = "https://<your-worker>.workers.dev/validate"; // ganti URL worker
  const WA_START_CHAT = "https://wa.me/6289674494567?text=Start";

  const form=document.getElementById('orderForm');
  const phone=document.getElementById('phone');
  const hiddenNorm=document.getElementById('phone_normalized');
  const msg=document.getElementById('msg');
  const msgOk=document.getElementById('msgOk');
  const btn=document.getElementById('submitBtn');
  let busy=false;

  function normalize62(input){
    const s=String(input||"").replace(/[^\d+]/g,"");
    if(!s) return "";
    if(s.startsWith("+62")) return s.slice(1);
    if(s.startsWith("62")) return s;
    if(s.startsWith("0")) return "62"+s.slice(1);
    if(s.startsWith("8")) return "62"+s;
    return s.replace(/^0+/,"");
  }
  function showErr(t){msg.textContent=t;msg.style.display="block";msgOk.style.display="none";}
  function showOk(t){msgOk.textContent=t;msgOk.style.display="block";msg.style.display="none";}
  function setBusy(b){busy=b;btn.textContent=b?"Mengecek...":"Ambil Promo";btn.disabled=b;}

  form.addEventListener('submit',async e=>{
    e.preventDefault(); if(busy) return;
    setBusy(true); showErr(""); showOk("");
    const norm=normalize62(phone.value);
    if(!/^62\d{7,15}$/.test(norm)){showErr("Nomor tidak valid.");setBusy(false);return;}
    try{
      const res=await fetch(`${WORKER_VALIDATE_URL}?phone=${encodeURIComponent(norm)}`);
      const j=await res.json();
      if(!j.ok){showErr("Validasi gagal");setBusy(false);return;}
      if(!j.exists){showErr("Nomor bukan WA aktif");setBusy(false);return;}
      hiddenNorm.value=norm;
      form.querySelector('input[name="redirect"]').value=WA_START_CHAT;
      showOk("Nomor terverifikasi âœ“");
      setTimeout(()=>form.submit(),150);
    }catch(err){showErr("Error koneksi");setBusy(false);}
  });
</script>

</body>
</html>
