<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Form Pemesanan</title>
<style>
  .loops-group { display:block; margin-bottom:20px; }
  .loops-group label { font-weight:bold; }
  .loops-group input { display:block; width:100%; height:36px; border:1px solid #ccc; border-radius:3px; padding:6px 10px; }
  .loops-group input.loops-submit { background:#81bd4b; color:#fff; cursor:pointer; }
  .loops-footer { font-size:11px; color:#ccc; font-style:italic; }
  .red { color:#B30000; }
  .msg { font-size:13px; margin-top:6px; display:none }
  .msg.err { color:#c02929 }
  .msg.ok { color:#22a06b }
</style>
</head>
<body>

<form id="loops-form-order" class="loops-forms"
      action="https://app.loops.id/save-order/test-lp-wa" method="POST">

  <div class="loops-group">
    <label for="name">Nama lengkap <span class="red">*</span></label>
    <input type="text" id="name" name="name" placeholder="Tulis nama Anda" required>
  </div>

  <div class="loops-group">
    <label for="phone">No HP <span class="red">*</span></label>
    <input type="text" id="phone" name="phone" placeholder="081234567890" required>
    <div id="msg" class="msg err"></div>
    <div id="msgOk" class="msg ok"></div>
  </div>

  <div class="loops-group">
    <input id="loops-form-submit" type="submit" value="Beli Sekarang" class="loops-submit">
  </div>

  <!-- Hidden untuk Loops -->
  <input type="hidden" id="current" name="current" value="">
  <input type="hidden" name="redirect" value=""> <!-- biarkan kosong, Loops yang atur -->
  <input type="hidden" name="_loops_nonce" value="">
  <!-- Tambahan tracking -->
  <input type="hidden" id="fbclid_field" name="fbclid" value="">
  <input type="hidden" id="phone_normalized" name="phone_normalized" value="">

  <p class="loops-footer">Powered by <a href="https://loops.id/?utm_source=form-embed">Loops.id</a>.</p>
</form>

<script>
  const WORKER_VALIDATE_URL = "https://watzap.annasmashuri97.workers.dev/validate";
  const form = document.getElementById('loops-form-order');
  const phone = document.getElementById('phone');
  const msg = document.getElementById('msg');
  const msgOk = document.getElementById('msgOk');
  const btn = document.getElementById('loops-form-submit');
  const hiddenNorm = document.getElementById('phone_normalized');
  let busy = false;

  // ambil fbclid
  const params = new URLSearchParams(window.location.search);
  const fbclid = params.get("fbclid");
  if(fbclid) document.getElementById("fbclid_field").value = fbclid;

  function normalize62(input){
    const s = String(input||"").replace(/[^\d+]/g,"");
    if(!s) return "";
    if(s.startsWith("+62")) return s.slice(1);
    if(s.startsWith("62")) return s;
    if(s.startsWith("0")) return "62"+s.slice(1);
    if(s.startsWith("8")) return "62"+s;
    return s.replace(/^0+/,"");
  }
  function showErr(t){ msg.textContent=t; msg.style.display="block"; msgOk.style.display="none"; }
  function showOk(t){ msgOk.textContent=t; msgOk.style.display="block"; msg.style.display="none"; }
  function setBusy(b){ busy=b; btn.value=b?"Mengecek...":"Beli Sekarang"; btn.disabled=b; }

  form.addEventListener('submit', async e=>{
    e.preventDefault(); if(busy) return;
    setBusy(true); showErr(""); showOk("");

    const norm = normalize62(phone.value);
    if(!/^62\d{7,15}$/.test(norm)){
      showErr("Nomor tidak valid"); setBusy(false); return;
    }

    try{
      const res = await fetch(`${WORKER_VALIDATE_URL}?phone=${encodeURIComponent(norm)}`, {cache:"no-store"});
      const j = await res.json();

      if(!j.ok){ showErr("Validasi gagal"); setBusy(false); return; }
      if(!j.exists){ showErr("Nomor bukan WA aktif"); setBusy(false); return; }

      hiddenNorm.value = norm;
      showOk("Nomor terverifikasi âœ“");
      setTimeout(()=>form.submit(), 200);

    }catch(err){
      showErr("Error koneksi"); setBusy(false);
    }
  });
</script>

</body>
</html>
